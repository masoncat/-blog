# 网络代理
要将网络代理，需要以http（HyperText Transfer Protocol）超文本传输协议为基础。

阮一峰老师的文章通俗易懂，方便大家学习。[HTTP协议入门](http://www.ruanyifeng.com/blog/2016/08/http.html)

看这篇文章，首先你要有DNS、ip、域名、端口、http协议、https是什么，这些概念。

## 原理
如字面意思一样，它是讲接收到的网络请求统一做代理。本来访问bao.qunar.com，直接打到ip为8.8.8.8.8的服务器上，一一对应。
如果请求量过大，服务器就直接爆炸了。
正常bao.quanr.com/file，会打到8.8.8.8.8/file二级路径下。你想放在另一台服务器，怎么办呢？

代理服务器，就是解决这些问题的。你可以指定请求到底打到哪台机器上面。


## 使用场景

### 移动端调试
我刚进公司培训的时候，就让安装Charles或者fiddler，手机连接电脑共享的wifi热点，然后设置对应域名和端口。就可以将电脑上的页面，在手机上查看，方便移动端调试。

### 本地开发
我们开发代码的时候，需要将网页链接的请求打到本地，方便开发。javascript是脚本语言，想要做些预编译，热配等操作，需要本地搭建一个服务。
当然你可以直接127.0.0.1+端口就可以访问到，但是许多时候，业务逻辑可能和域名相关联，或者连接beta环境做调试，就需要将请求代理到本地了。

### 服务器转发
这种叫做代理服务器，一方面是考虑安全性，另一方面是方便做转发管理，常用nginx来做。高并发负载均衡。


## 工具
### hosts
这个是最基本的代理吧，就是本地的一个静态配置文件。设置域名和ip的静态关系，需要手动去维护。
mac下是/etc/hosts

### SwitchyOmega
chrome的一款良心插件，可以根据情景去设置代理。
将浏览器的请求通通代理到指定的端口上，如果你的Charles没有抓到浏览器的请求，可以看看浏览器的代理设置是什么。
### Charles
本文是讲网络代理的，所以charles的具体使用就不展开讲了，重点讲它是如何代理的。
官方给的解释是HTTP代理服务器，反转代理服务器。
设置Charles的代理后，电脑发出和接收的请求都会经过Charles。你可以查看具体请求信息，也可以将其拦截修改。
注意，https请求Charles默认解析不了，需要到Charles官网下载ssl证书。
### nginx
nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。特点是占有内存少，并发能力强。
我司一般是请求先打到指定的nginx服务器上，再根据配置转发到对应的服务。
它的配置文件conf是个可以直接修改的静态文件，只要掌握基本的语法即可，高深的很少用到，除非你是做运维。


## 遇到的问题

### DNS缓存
上周遇到一个故障，客户反馈进入页面白屏，立即用手机测试，是好的。用公司wifi，也是好的。
后面开始大面积反馈白屏，整个公司就沸腾了，赶紧查问题！！
反复定位后，确认是指定的wifi下，js加载不到，导致白屏。切换wifi，开飞行模式，在切回来就好了。
原来提供CDN服务的厂商添加了，我们的DNS对这个做了限制，导致部分的js加载不到。最开始让客户切换wifi，还是不行，是因为DNS有缓存，依旧打到旧的IP，导致定位问题时间较长。
目前看来，这种时好时坏，部分好部分坏的问题，可以从网络代理层面去考虑。

### https证书
公司的网页都是https，这给beta环境和本地dev环境调试带来不便，有些问题只有在https下才会有。
一种是在Charles拦截请求和html页面，做替换。
一种是可以配置nginx,将https请求拦截到本地http端口上。

再有网页会存在该证书不受信任的问题，电脑上可以自制对应域名的证书，授予信任，这个其实很危险。请求只要伪造成该域名下，就可以通过许可。调试不在此列。




